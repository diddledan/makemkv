name: makemkv
version: '1.12.2'
summary: Backup your Bluray and DVD discs
description: |
  Backup your Bluray and DVD discs

grade: devel
confinement: strict

architectures:
- build-on: amd64
- build-on: i386

apps:
  makemkv:
    command: desktop-launch $SNAP/usr/bin/makemkv
    desktop: usr/share/applications/makemkv.desktop
    environment:
      MAKEMKVCON: $SNAP/usr/bin/makemkvcon
      JAVA_HOME: $SNAP/usr
    plugs:
    # - account-control
    - desktop
    - desktop-legacy
    - gsettings
    - home
    - opengl
    - optical-drive
    - process-control
    - removable-media
    - wayland
    - x11

  makemkvcon:
    command: usr/bin/makemkvcon
    environment:
      JAVA_HOME: $SNAP/usr
    plugs:
    - hardware-observe
    - home
    - optical-drive
    - process-control
    - removable-media

parts:
  libav:
    source: http://ffmpeg.org/releases/ffmpeg-3.4.tar.bz2
    plugin: autotools
    build-packages:
    - libfdk-aac-dev
    - yasm
    configflags:
    - --prefix=/usr
    - --enable-pic
    - --disable-shared
    - --enable-libfdk-aac
    - --disable-cuda
    - --disable-cuvid
    stage-packages:
    - libfdk-aac0
    - libxcb-shape0
    prime:
    - -**/*.a
    - -**/*.la

  patches:
    plugin: dump
    source: ./patches
    prime:
    - -*

  makemkv-oss:
    after: [patches, desktop-qt4, libav, snapcraft-preload]
    source: http://www.makemkv.com/download/makemkv-oss-$SNAPCRAFT_PROJECT_VERSION.tar.gz
    plugin: autotools
    build-packages:
    - libexpat1-dev
    - libgl1-mesa-dev
    - libqt4-dev
    - libssl-dev
    prepare: |
      patch -Np1 < $SNAPCRAFT_STAGE/patch.diff
      sed -i 's|Icon=.*|Icon=${SNAP}/usr/share/icons/hicolor/128x128/apps/makemkv.png|' makemkvgui/share/makemkv.desktop
    configflags:
    # - --prefix=/snap/$SNAPCRAFT_PROJECT_NAME/current/usr
    - --prefix=/usr
    stage-packages:
    - adwaita-icon-theme
    - libexpat1
    - libgconf-2-4
    - libqtcore4
    - libqtgui4
    - libqt4-network
    - libssl1.0.0
    - qt-at-spi
    organize:
      usr/lib/**/gio: usr/lib/gio
    #   snap/*/current/usr/bin/*: usr/bin/
    #   snap/*/current/usr/lib/*: usr/lib/
    #   snap/*/current/usr/share/*: usr/share/
    prime:
    - -**/*.a
    - -**/*.la

  makemkv-bin:
    after: [snapcraft-preload]
    source: http://www.makemkv.com/download/makemkv-bin-$SNAPCRAFT_PROJECT_VERSION.tar.gz
    plugin: make
    build-packages:
    - default-jre # used to work out the right symlink dir in `install`
    - execstack
    prepare: |
      mkdir tmp && touch tmp/eula_accepted
      execstack -c bin/amd64/makemkvcon
      execstack -c bin/i386/makemkvcon
      execstack -c bin/i386/mmdtsdec
    install: |
      JDK=$(find /usr/lib/jvm -type d -name "java-8-openjdk-*" | head -n1 | xargs basename)
      JDKBIN=../lib/jvm/$JDK/jre/bin
      for exec in java javaws jexec jjs; do
        ln -s $JDKBIN/$exec $SNAPCRAFT_PART_INSTALL/usr/bin/$exec
      done
    stage:
    - -usr/lib/jvm/java-8-openjdk-amd64/jre/lib/security/cacerts
    stage-packages:
    - default-jre
    prime:
    - -**/*.a
    - -**/*.la
